<!--
    This file is part of MyDMAM.

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 3 of the License, or
    any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    GNU General Public License for more details.

    Copyright (C) Media ex Machina 2025

-->

@let searchResult = searchResponse();
@if (searchResult != null) {
    <h1>Search results for <span class="search-q">{{ searchResult.q }}</span></h1>

    @if (searchResult.result.totalFounded == 0) {
        <p>No results found.</p>
    } @else {
        @if (searchResult.result.totalFounded == searchResult.result.foundedFiles.length) {
            <p>Display {{ searchResult.result.totalFounded }}
                @if (searchResult.result.totalFounded == 1) {
                    result:
                } @else {
                    results:
                }
            </p>
        } @else {
            <p>Found {{ searchResult.result.totalFounded }} results, display only the {{ searchResult.result.foundedFiles.length }} bests.</p>
        }
    }

    @let currentSearchConstraints = searchConstraints();
    @if (currentSearchConstraints == null) {
        <button (click)="createSearchConstraints($event)">Set search constraints</button>
    } @else {
        <h3>Search constraints:</h3>

        <ul>
            <li>
                <app-search-constraint-condition-editor
                    [labelStateIgnore]="'Files and directories'"
                    [labelStateMust]="'Directories only'"
                    [labelStateMustNot]="'Files only'"
                    [condition]="currentSearchConstraints.fileConstraints.directory"
                    (onChange)="onChangeSearchConstraintsCondition($event, 'directory')">
                </app-search-constraint-condition-editor>
            </li>

            <li>
                <app-search-constraints-storage-editor
                    [storageList]="storageList()"
                    [condition]="currentSearchConstraints.fileConstraints.storages"
                    (onChange)="onChangeSearchConstraintsStorages($event)">
                </app-search-constraints-storage-editor>
            </li>

            <li>
                <app-search-constraints-parent-path-editor
                    [parentPath]="currentSearchConstraints.fileConstraints.parentPath"
                    (onChange)="onChangeSearchConstraintsParentPath($event)">
                </app-search-constraints-parent-path-editor>
            </li>

            <li>
                <app-search-constraint-date-range-editor
                    [range]="currentSearchConstraints.fileConstraints.date"
                    (onChange)="onChangeSearchConstraintsRange($event, 'date')">
                </app-search-constraint-date-range-editor>
            </li>

            <li>
                <app-search-constraints-size-range-editor
                    [range]="currentSearchConstraints.fileConstraints.size"
                    (onChange)="onChangeSearchConstraintsRange($event, 'size')">
                </app-search-constraints-size-range-editor>
            </li>

            <li>
                <app-search-constraint-condition-editor
                    [labelStateIgnore]="'No hidden constraint'"
                    [labelStateMust]="'Only hidden'"
                    [labelStateMustNot]="'Never hidden'"
                    [condition]="currentSearchConstraints.fileConstraints.hidden"
                    (onChange)="onChangeSearchConstraintsCondition($event, 'hidden')">
                </app-search-constraint-condition-editor>
            </li>

            <li>
                <app-search-constraint-condition-editor
                    [labelStateIgnore]="'No link constraint'"
                    [labelStateMust]="'Only links'"
                    [labelStateMustNot]="'Never links'"
                    [condition]="currentSearchConstraints.fileConstraints.link"
                    (onChange)="onChangeSearchConstraintsCondition($event, 'link')">
                </app-search-constraint-condition-editor>
            </li>

            <li>
                <app-search-constraint-condition-editor
                    [labelStateIgnore]="'No special files constraint'"
                    [labelStateMust]="'Only special files'"
                    [labelStateMustNot]="'Never special files'"
                    [condition]="currentSearchConstraints.fileConstraints.special"
                    (onChange)="onChangeSearchConstraintsCondition($event, 'special')">
                </app-search-constraint-condition-editor>
            </li>
        </ul>

        <button (click)="removeSearchConstraints($event)">Remove search constraints</button>
    }


    <ul>
        @for (item of searchResult.result.foundedFiles; track item.hashPath) {
            @let relatedFile = searchResult.relatedFiles[item.hashPath];
            <li>
                <a class="result-item-title" [routerLink]="['/navigator', item.storage, item.hashPath]"
                   [queryParams]="{ q: searchResult.q }">
                    {{ item.name }}
                </a>
                <div class="attributes">
                    <div>
                        @if (relatedFile.directory) {
                            Directory
                        } @else {
                            Regular file: <app-span-file-size [size]="relatedFile.length || 0"></app-span-file-size>,
                            modified <app-span-date-time [date]="relatedFile.modified"></app-span-date-time>
                        }
                    </div>
                    <div>
                        Located in
                        <a [routerLink]="['/navigator', item.storage]"
                        [queryParams]="{ q: searchResult.q }">
                            {{ item.storage }}
                        </a>
                        :
                        <a [routerLink]="['/navigator', item.storage, fileSystemService.hashPath(item.storage, item.parentPath)]"
                        [queryParams]="{ q: searchResult.q }">
                            {{ item.parentPath }}
                        </a>
                    </div>
                </div>
            </li>
        }
    </ul>

} @else if (pendingSearch()) {
    <h1>Pending search...</h1>
} @else {
    <h1>Search: no results to display</h1>
}
